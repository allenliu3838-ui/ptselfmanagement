/* constants.js - Pure data constants and configuration */
/* Kidney Care PWA - Programized v7 (internal beta)
   - One app, multiple Programs: Kidney follow-up / Stone / Pediatric nephrology
   - Safety overlay: electrolyte & red-flag triage
   - Local-first: data stored in localStorage
*/
// Versioning note (Netlify + PWA):
// - Bump VERSION whenever you deploy to ensure SW cache separation and visible build identity.
const VERSION = "9.9.0";
const STORAGE_KEY = "kidneyCareStateV7";

const PROGRAMS = {
  kidney: { key: "kidney", name: "肾脏随访", subtitle: "肾功/尿蛋白/移植等随访整理（可联动慢病）" },
  htn:    { key: "htn",    name: "高血压随访", subtitle: "家庭血压/用药依从/风险信号" },
  dm:     { key: "dm",     name: "糖尿病随访", subtitle: "血糖/HbA1c/低血糖事件" },
  dialysis:{ key: "dialysis", name: "透析随访", subtitle: "血透/腹透：控水、电解质、通路/腹透红旗" },
  stone:  { key: "stone",  name: "肾结石管理", subtitle: "喝水/发作事件/影像复查提醒" },
  peds:   { key: "peds",   name: "儿肾随访", subtitle: "家长协作 + 生长 + 儿科血压/肾功能" },
};


// Workspace tab labels (reduce confusion: each program feels like its own "workspace")
const WORKSPACE_TABS = {
  kidney:  { records: "病历", followup: "随访" },
  htn:     { records: "血压", followup: "计划" },
  dm:      { records: "控糖", followup: "计划" },
  dialysis:{ records: "透析", followup: "计划" },
  stone:   { records: "结石", followup: "计划" },
  peds:    { records: "成长", followup: "随访" },
};

// Tab pages (overlay pages like 'explain'/'guide' should NOT reset tab highlight)
const TAB_KEYS = ["home","ai","records","docs","me"];
let currentTabKey = "home";

// Tab visibility (reduce confusion for first-time testers)
function showAITab(){
  try{
    if(state && state.ui && typeof state.ui.showAI !== "undefined") return !!state.ui.showAI;
  }catch(_e){}
  return true;
}


const COMORB = [
  { key: "htn", label: "高血压" },
  { key: "dm",  label: "糖尿病" },
  { key: "masld", label: "脂肪肝/MASLD（NASH/MASH）" },
  { key: "hf",  label: "心衰/心血管" },
  { key: "aki", label: "AKI/AKD康复" },
];

const DIET_TAGS = {
  lowNa: { key:"lowNa", label:"控盐/控钠" },
  lowK:  { key:"lowK",  label:"限钾" },
  lowP:  { key:"lowP",  label:"控磷" },
  lowSugar:{ key:"lowSugar", label:"控糖" },
  fluidLimit:{ key:"fluidLimit", label:"控水/限水" },
  caMbd: { key:"caMbd", label:"钙/骨矿物" },
  foodSafety:{ key:"foodSafety", label:"移植食品安全" },
  drugFood:{ key:"drugFood", label:"药食相互作用" },
};


// ====== Diet Food Library (v1) ======
// Goals:
// - High potassium / high phosphorus food library with search + per-item explanation
// - Keep the patient mental model: 指标异常 -> 本周重点 -> 点食物看解释与替代
// NOTE: 这是内测版教育内容占位；正式版建议由中心/营养师审核并可配置下发。

const DIET_LIBRARY_VERSION = "1.0";

const FOOD_TAG = {
  highK: { key:"highK", label:"高钾" },
  highP: { key:"highP", label:"高磷" },
  additiveP: { key:"additiveP", label:"磷添加剂/高度加工" },
  double: { key:"double", label:"钾+磷双高" },
  tip: { key:"tip", label:"避坑提示" },
  tx: { key:"tx", label:"移植食品安全" },
};

const FOOD_LEVEL = {
  high:   { key:"high",   label:"重点少吃", badge:"danger" },
  caution:{ key:"caution",label:"谨慎/看份量", badge:"info" },
  tip:    { key:"tip",    label:"避坑", badge:"info" },
  safer:  { key:"safer",  label:"相对更稳", badge:"ok" },
};

// Minimal, practical starter list (Top items). Expand iteratively based on real patient questions.
const FOOD_DB = [
  // --- 高钾避坑（特别重要） ---
  {
    id:"salt_substitute",
    name:"低钠盐/盐替代品",
    aliases:["低钠盐","代盐","盐替代","氯化钾","钾盐"],
    tags:["highK","tip"],
    level:"high",
    summary:"很多‘低钠盐’用氯化钾替代部分氯化钠，血钾偏高时要特别谨慎。",
    why:[
      "当血钾偏高时，额外摄入钾可能加重高钾风险。",
      "部分患者同时用影响血钾的药物时，更需要先问团队再换盐。"
    ],
    tips:[
      "先看配料表：是否含‘氯化钾/钾盐’。",
      "如果医生提示血钾偏高，不要自行继续使用代盐；尽快咨询随访团队。"
    ],
    alternatives:["普通食盐（控制总量）","用香辛料/醋/柠檬增味（减少盐用量）"],
    caution:"饮食建议仅作教育提示；如你在透析/移植随访，请以中心个体化方案为准。"
  },
  {
    id:"coconut_water",
    name:"椰子水/椰汁",
    aliases:["椰子水","椰汁"],
    tags:["highK"],
    level:"high",
    summary:"常被当作‘健康饮料’，但可能含较多钾。",
    why:["血钾偏高时，应优先避免或严格控制含钾饮料的摄入。"],
    tips:["选择白水/无糖茶更稳妥。"],
    alternatives:["白水","无糖茶"],
    caution:"不同品牌配方差异大；如果你在控钾，请先以‘不喝/少喝’作为默认策略。"
  },
  {
    id:"veg_juice",
    name:"果蔬汁/浓汤/火锅汤底",
    aliases:["果汁","蔬菜汁","浓汤","火锅汤","汤底"],
    tags:["highK","tip"],
    level:"high",
    summary:"把多种食材‘浓缩’进液体里，钾更容易累积。",
    why:["血钾偏高时，液体形式的‘浓缩钾’更容易超量。"],
    tips:["优先吃‘原型食物’，少喝汤。若必须饮用，先与团队确认份量。"],
    alternatives:["清淡主食+少量配菜","白水"],
    caution:"如果你同时有透析限水/心衰控水，请优先按限水医嘱。"
  },

  // --- 常见高钾水果 ---
  {
    id:"banana",
    name:"香蕉",
    aliases:["香蕉"],
    tags:["highK"],
    level:"high",
    summary:"常见高钾水果；血钾偏高时不建议随意加量。",
    why:["血钾偏高时，香蕉可能让控钾更困难。"],
    tips:["如医生允许，考虑小份量+降低频率；先把‘代盐/饮料’这些更隐蔽的钾源控制住。"],
    alternatives:["苹果","梨","葡萄（按量）","草莓等浆果（按量）"],
    caution:"不同患者的钾目标不同；透析/移植/CKD 分期不同，策略也不同。"
  },
  {
    id:"orange_juice",
    name:"橙子/橙汁",
    aliases:["橙子","橙汁","柑橘"],
    tags:["highK"],
    level:"high",
    summary:"整果与果汁都需要注意；果汁更容易喝多。",
    why:["果汁形式更容易一次摄入较多钾。"],
    tips:["优先吃整果而不是果汁；血钾偏高时建议先避免。"],
    alternatives:["白水","无糖茶","小份量低钾水果（按医嘱）"],
    caution:"如你同时控糖，果汁也不建议。"
  },
  {
    id:"kiwi",
    name:"猕猴桃",
    aliases:["猕猴桃"],
    tags:["highK"],
    level:"caution",
    summary:"部分高钾水果；血钾高时建议减少或先停。",
    why:["血钾偏高时应优先避免高钾水果。"],
    tips:["先看你最近的血钾趋势，再决定是否/多少。"],
    alternatives:["苹果","梨"],
    caution:"如果你近期血钾正常，未必需要严格限制；以团队建议为准。"
  },
  {
    id:"melon",
    name:"哈密瓜/甜瓜",
    aliases:["哈密瓜","甜瓜","香瓜"],
    tags:["highK"],
    level:"caution",
    summary:"部分瓜类水果钾不低；容易一次吃多。",
    why:["血钾偏高时，大份量水果可能让钾摄入超标。"],
    tips:["若医生允许，尽量小份量；避免当‘解渴’大量摄入。"],
    alternatives:["少量低钾水果（按医嘱）","白水"],
    caution:"如果你有透析限水医嘱，‘用瓜果解渴’更容易失控。"
  },
  {
    id:"avocado",
    name:"牛油果",
    aliases:["牛油果","鳄梨"],
    tags:["highK"],
    level:"high",
    summary:"经常被忽略的高钾食物。",
    why:["血钾偏高时，牛油果可能不适合作为日常‘加餐’。"],
    tips:["如果你喜欢，建议把它当作‘偶尔少量’，并先与团队确认。"],
    alternatives:["少量橄榄油调味","少量低钾水果（按医嘱）"],
    caution:"同时控脂/控糖的患者，仍需关注总能量。"
  },
  {
    id:"dried_fruit",
    name:"干果/蜜饯（枣、葡萄干等）",
    aliases:["枣","葡萄干","杏干","蜜饯","果脯"],
    tags:["highK"],
    level:"high",
    summary:"干制会‘浓缩’营养与钾，容易一口气吃多。",
    why:["血钾偏高时，干果/蜜饯可能让钾摄入迅速累积。"],
    tips:["血钾偏高时建议先避免；如果只是想解馋，尽量选择低钾替代（按医嘱）。"],
    alternatives:["少量低钾水果（按医嘱）"],
    caution:"很多蜜饯含糖高；糖尿病/移植用激素人群更要谨慎。"
  },

  // --- 常见高钾蔬菜/主食 ---
  {
    id:"potato",
    name:"土豆/土豆泥/薯条",
    aliases:["土豆","土豆泥","薯条","薯片"],
    tags:["highK"],
    level:"high",
    summary:"土豆类往往钾较高；油炸/加工形式还会带来额外负担。",
    why:["血钾偏高时，土豆类可能增加控钾难度。"],
    tips:["若医生允许，可考虑‘切块→先焯/先煮→弃水’再烹饪的做法，帮助减少钾（但仍要看份量）。"],
    alternatives:["米饭","面条","馒头等主食（按个体方案）"],
    caution:"如果你同时控磷/控脂/控糖，请综合选择烹饪方式与份量。"
  },
  {
    id:"sweet_potato",
    name:"红薯/地瓜",
    aliases:["红薯","地瓜","紫薯"],
    tags:["highK"],
    level:"high",
    summary:"常见高钾根茎类；易被当作‘粗粮健康食品’而吃多。",
    why:["血钾偏高时，红薯类可能不适合当主食大量摄入。"],
    tips:["若医生允许，尽量小份量；优先把‘饮料/代盐’这些隐蔽钾源先控制住。"],
    alternatives:["米饭/面条等（按医嘱）"],
    caution:"不同烹饪方式与份量差异很大。"
  },
  {
    id:"tomato_products",
    name:"番茄及番茄制品（番茄酱/番茄汁）",
    aliases:["番茄","西红柿","番茄酱","番茄汁"],
    tags:["highK"],
    level:"caution",
    summary:"番茄制品更容易‘浓缩’，血钾偏高时要注意份量。",
    why:["番茄制品（酱/汁）更容易一次摄入较多钾。"],
    tips:["血钾偏高时，优先减少番茄酱/番茄汁；少量新鲜番茄是否可用以医嘱为准。"],
    alternatives:["用葱姜蒜/醋/香草做调味"],
    caution:"加工番茄酱同时可能含盐高；高血压人群也要注意。"
  },
  {
    id:"spinach_cooked",
    name:"熟菠菜",
    aliases:["菠菜"],
    tags:["highK"],
    level:"caution",
    summary:"部分绿叶菜钾不低；烹饪与份量很关键。",
    why:["血钾偏高时，绿叶菜的大份量摄入可能增加钾负担。"],
    tips:["可考虑焯水后再炒/拌，帮助减少部分可溶性成分；但最终仍看份量与医嘱。"],
    alternatives:["部分瓜类/菌菇类（按个体方案）"],
    caution:"蔬菜总体仍重要，避免把‘限钾’理解成‘不吃菜’。"
  },
  {
    id:"seaweed",
    name:"海带/紫菜等海藻类",
    aliases:["海带","紫菜","海藻"],
    tags:["highK"],
    level:"high",
    summary:"海藻类矿物质含量高，血钾偏高时不建议常吃。",
    why:["血钾偏高时，海藻类可能增加钾摄入。"],
    tips:["喜欢喝紫菜汤的患者，血钾高时建议先停。"],
    alternatives:["清淡蔬菜汤（少喝汤）"],
    caution:"部分海藻类也可能影响碘摄入；以医生建议为准。"
  },
  {
    id:"beans",
    name:"豆类（红豆/绿豆/扁豆等）",
    aliases:["红豆","绿豆","黄豆","扁豆","鹰嘴豆"],
    tags:["highK","highP","double"],
    level:"caution",
    summary:"豆类常同时涉及钾与磷；是否限制取决于人群与份量。",
    why:[
      "对需要控钾/控磷的人群，豆类可能不是‘随意加量’的食物。",
      "豆类也有蛋白与纤维价值，是否限制应个体化。"
    ],
    tips:["把‘份量’作为第一原则；如果你同时在透析/控磷，建议把问题带给营养师/医生。"],
    alternatives:["按方案选择适合的蛋白来源（鸡蛋清/鱼肉等需个体化）"],
    caution:"植物性磷的吸收率与添加剂不同；正式版建议接入营养师配置。"
  },
  {
    id:"mushroom",
    name:"菌菇类（香菇等）",
    aliases:["香菇","蘑菇","菌菇"],
    tags:["highK"],
    level:"caution",
    summary:"部分菌菇钾不低；看份量。",
    why:["血钾偏高时，大份量菌菇类可能增加钾负担。"],
    tips:["若你血钾正常，多数情况下不必恐慌；高钾时优先把‘代盐/饮料/汤’先控制。"],
    alternatives:["少量其他蔬菜（按医嘱）"],
    caution:"不同品种差异较大。"
  },

  // --- 高磷核心：添加剂与高度加工（最该优先避开） ---
  {
    id:"phos_additives",
    name:"含磷添加剂的加工食品（重点）",
    aliases:["磷添加剂","磷酸盐","phos","加工食品"],
    tags:["highP","additiveP","tip"],
    level:"high",
    summary:"很多高度加工食品含‘磷酸盐添加剂’，更隐蔽、吸收率更高。",
    why:[
      "含磷添加剂（无机磷）更容易被吸收，对控磷更不利。",
      "相同‘磷含量’，添加剂来源通常比天然食物更需要优先避开。"
    ],
    tips:[
      "看配料表：出现‘磷酸盐/磷酸/焦磷酸/多聚磷酸盐’或英文含‘PHOS’字样时要提高警惕。",
      "优先选择少加工/原型食物；同类食品尽量选‘配料表更短’的。"
    ],
    alternatives:["新鲜现做饭菜","原型肉/蛋/菜（按个体方案）"],
    caution:"控磷通常需要结合透析参数/药物（如磷结合剂）与医生方案；App 不替代医疗决策。"
  },
  {
    id:"cola",
    name:"可乐/深色碳酸饮料",
    aliases:["可乐","深色汽水","碳酸饮料"],
    tags:["highP","additiveP"],
    level:"high",
    summary:"部分深色碳酸饮料含磷酸盐/磷酸，控磷人群建议先避免。",
    why:["控磷阶段，饮料可能成为‘最容易减少且收益很大’的来源之一。"],
    tips:["优先白水/无糖茶；同时控糖人群也更适合。"],
    alternatives:["白水","无糖茶"],
    caution:"不同品牌/口味差异大；如果你处于透析控磷阶段，建议默认避免。"
  },
  {
    id:"processed_meat",
    name:"加工肉制品（火腿/香肠/培根/午餐肉）",
    aliases:["火腿","香肠","培根","午餐肉","腊肉"],
    tags:["highP","additiveP"],
    level:"high",
    summary:"常含磷添加剂且盐也高；对控磷/控盐都不友好。",
    why:["控磷时应优先减少加工食品；加工肉往往是典型‘双不友好’。"],
    tips:["想吃肉时，优先选择‘原型肉’少加工做法，并注意总盐。"],
    alternatives:["新鲜瘦肉/鱼肉（按个体方案）"],
    caution:"移植人群需注意食品安全：避免生冷、注意加热与保存。"
  },
  {
    id:"instant_food",
    name:"方便面/速食/预制菜",
    aliases:["方便面","速食","预制菜"],
    tags:["highP","additiveP","tip"],
    level:"high",
    summary:"配料复杂，可能同时带来磷添加剂与高盐。",
    why:["控磷/控盐人群，减少高度加工食品通常收益很大。"],
    tips:["如果实在需要：尽量少用调料包、少喝汤，并增加新鲜蔬菜（按医嘱）。"],
    alternatives:["简单现做：米饭+清炒菜+少量蛋白（按个体方案）"],
    caution:"‘少用调料包’并不等于安全；最稳妥仍是减少频率。"
  },
  {
    id:"processed_cheese",
    name:"加工芝士/奶酪片",
    aliases:["芝士","奶酪","芝士片"],
    tags:["highP","additiveP"],
    level:"caution",
    summary:"部分加工奶酪可能含磷添加剂，控磷人群要注意。",
    why:["控磷阶段应减少含添加剂的乳制品/加工奶酪。"],
    tips:["如你需要补蛋白/补钙，请先与医生/营养师确定优先级。"],
    alternatives:["按个体方案选择乳制品或其他来源"],
    caution:"控磷与补钙/骨矿物管理常需要一起评估。"
  },

  // --- 天然高磷：更强调‘份量/人群’ ---
  {
    id:"nuts",
    name:"坚果/花生酱",
    aliases:["坚果","花生","杏仁","核桃","花生酱"],
    tags:["highK","highP","double"],
    level:"caution",
    summary:"常同时涉及钾与磷；也可能能量高。",
    why:["在控钾/控磷阶段，坚果不适合作为‘随手一大把’的加餐。"],
    tips:["如果医生允许，尽量‘小份量’；更优先减少‘加工食品+含添加剂’。"],
    alternatives:["按个体方案选择更合适的加餐"],
    caution:"不同坚果差异很大；正式版可做‘按份量可视化’。"
  },
  {
    id:"organ_meat",
    name:"动物内脏",
    aliases:["内脏","肝","腰子"],
    tags:["highP"],
    level:"high",
    summary:"磷含量往往较高；控磷人群不建议常吃。",
    why:["控磷阶段，减少内脏类摄入通常更稳妥。"],
    tips:["若你是为了补铁/补营养，请让团队给出更安全的替代方案。"],
    alternatives:["按个体方案选择蛋白/补铁途径"],
    caution:"不同人群差异很大：移植/透析/CKD 的重点不同。"
  },
  {
    id:"egg_yolk",
    name:"蛋黄",
    aliases:["蛋黄"],
    tags:["highP"],
    level:"caution",
    summary:"蛋黄磷相对更多；是否限制取决于你的控磷目标与蛋白需求。",
    why:["控磷人群常需要平衡‘优质蛋白’与‘磷负担’。"],
    tips:["如果医生强调控磷，可考虑与营养师讨论‘蛋白来源’与‘频率’。"],
    alternatives:["鸡蛋清（蛋白）等（需个体化）"],
    caution:"不要自行长期低蛋白/过度限制，避免营养不良。"
  },
  {
    id:"milk",
    name:"牛奶/奶粉/酸奶",
    aliases:["牛奶","奶粉","酸奶"],
    tags:["highP"],
    level:"caution",
    summary:"乳制品含磷；是否需要限制取决于你的血磷与医生方案。",
    why:["控磷阶段，乳制品可能需要重新规划‘份量与频率’。"],
    tips:["如果你同时在做骨矿物管理（钙/维D/PTH），更建议让团队给出一揽子方案。"],
    alternatives:["按个体方案选择乳制品或其他来源"],
    caution:"不同品牌/配方差异大。"
  },

  // --- 移植食品安全（占位提醒） ---
  {
    id:"tx_food_safety",
    name:"移植期：食品安全优先",
    aliases:["移植","免疫抑制","食品安全"],
    tags:["tx","tip"],
    level:"tip",
    summary:"免疫抑制期更怕食源性感染：避免生食/半生，注意分餐与冷藏。",
    why:["移植期饮食首先要守住‘食品安全’，很多风险来自不洁/生冷食物。"],
    tips:["避免生鱼片/生蛋/未充分加热的肉；外卖尽量选择熟食与正规商家。"],
    alternatives:["熟食/现做热食"],
    caution:"具体以你的移植中心宣教为准。"
  },
];

// ====== Diet Guides (v1) ======
// 目的：把“原则性饮食方案”做成独立页面，避免与单个食物解释混在一起。
// 说明：正式版建议由肝病/营养团队审核；此处用于内测结构与交互验证。

const DIET_GUIDE_VERSION = "1.1";

const DIET_GUIDES = [
  {
    id: "masld",
    title: "脂肪肝/MASLD（NASH/MASH）饮食要点",
    subtitle: "核心：逐步减重 + 少糖少加工（肾友好版本示意）",
    sections: [
      {
        t: "先说明术语",
        s: [
          "你可能听过 NAFLD/NASH。近年更常用 MASLD（代谢相关脂肪性肝病）与 MASH（代谢相关脂肪性肝炎）来描述同类问题。",
          "无论叫法如何，管理的第一核心通常都是：体重管理 + 代谢改善（血糖/血脂/血压）。"
        ]
      },
      {
        t: "最重要的目标",
        s: [
          "如果超重/肥胖：在医生/营养师指导下‘逐步’减重更安全。",
          "很多宣教会把‘减重 7–10%’作为改善肝脏炎症/纤维化的常见目标；更小的减重也可能降低肝脂肪。",
          "避免‘快速减重/极端节食’，可能适得其反。"
        ]
      },
      {
        t: "饮食原则（最省力、最不容易走偏）",
        s: [
          "少含糖饮料与果汁：它们更容易导致总能量过量与血糖波动。",
          "少精制主食与甜点：把‘白米面/甜点’逐步换成更耐饱的主食（按你的肾功能与医生建议决定份量）。",
          "少油炸与高饱和脂肪：减少肥肉、油炸、奶油/酥点等。",
          "多‘原型食物’：新鲜食材、清淡烹饪；少高度加工食品（也有助于控磷添加剂）。",
          "优先优质蛋白：鱼、禽、蛋、瘦肉、豆制品等（肾功能不同，蛋白目标不同，请以随访方案为准）。"
        ]
      },
      {
        t: "运动与生活方式（对肝和肾都加分）",
        s: [
          "如果条件允许：每周累计≥150分钟中等强度运动（如快走）+ 每周2次抗阻训练，是常见推荐。",
          "运动即使不明显减重，也可能带来代谢改善。",
          "如有心衰/透析/术后等情况，运动强度请先和医生确认。"
        ]
      },
      {
        t: "与肾病/移植/透析如何兼容（非常重要）",
        s: [
          "如果你在‘限钾/控磷/限水’，请优先遵循肾脏随访方案：本App 的高钾/高磷食物库用于‘避坑’。",
          "地中海式饮食常含坚果、豆类、部分水果蔬菜——但这些在‘高钾/高磷’时可能需要‘份量控制或替代’，不要盲目照搬。",
          "最稳的顺序：先把含糖饮料/甜点/油炸/加工食品减少；再在医生允许范围内优化蔬果与主食结构。"
        ]
      },
    ],
    footer: "边界：本指南为健康教育提示，不替代肝病/肾病医生与营养师的个体化处方。若出现黄疸、呕血黑便、明显腹胀、意识异常等情况请及时就医。"
  },
  {
    id: "dash",
    title: "DASH 饮食（得舒饮食）",
    subtitle: "控制高血压的经典饮食方案 · 肾友好版本",
    sections: [
      {
        t: "什么是 DASH 饮食？",
        s: [
          "DASH = Dietary Approaches to Stop Hypertension（用饮食方法控制高血压）。",
          "这是临床研究支持最充分的降压饮食模式之一，被多国高血压指南推荐。",
          "核心思路：多蔬果、多全谷物、多低脂乳制品，限盐、限饱和脂肪、限糖。"
        ]
      },
      {
        t: "DASH 的 5 个关键原则",
        s: [
          "1. 减盐：目标通常建议 <6g/天（约一啤酒瓶盖），部分指南更严格至 <5g/天。少放盐、少酱料、少加工食品。",
          "2. 多蔬菜水果：每天 4–5 份蔬菜 + 4–5 份水果（注意：肾功能不全/高血钾者需遵医嘱控制高钾蔬果的份量）。",
          "3. 全谷物替代精制主食：糙米、燕麦、全麦面包等比白米面更有利于血压与血糖控制。",
          "4. 优质蛋白 + 低脂乳制品：鱼、禽肉、豆制品、低脂牛奶/酸奶；减少红肉与加工肉制品。",
          "5. 限糖 + 好脂肪：少含糖饮料与甜点；用坚果、橄榄油、鱼油等替代饱和脂肪（黄油、肥肉、油炸）。"
        ]
      },
      {
        t: "DASH 对哪些人最有帮助？",
        s: [
          "高血压患者（尤其是盐敏感型高血压）。",
          "CKD 早期（eGFR > 30）合并高血压者——研究显示 DASH 对减缓肾功能下降也可能有益。",
          "糖尿病合并高血压者——DASH 对血糖控制也有辅助作用。"
        ]
      },
      {
        t: "肾病患者的特别注意事项（非常重要）",
        s: [
          "标准 DASH 鼓励大量蔬果和全谷物——但这些往往含钾较高。如果你有高钾血症风险（如 CKD 3b–5 期、透析、使用 RAAS 阻断剂），必须在医生/营养师指导下调整份量。",
          "标准 DASH 鼓励低脂乳制品和豆制品——这些含磷较高。如果你在控磷，需注意份量或选择磷含量更低的替代品。",
          "标准 DASH 强调全谷物——这些有机磷的生物利用度相对低于加工食品添加的无机磷，但仍需与营养师讨论合适的量。",
          "简单原则：先做到'减盐'这一步（对所有人都安全），再在医生允许范围内逐步优化蔬果和主食结构。"
        ]
      },
      {
        t: "最省力的起步建议",
        s: [
          "第一周：关注'减盐'——不加额外盐、少酱料、少腌制食品、不用含钾代盐。",
          "第二周：开始增加蔬菜（先选低钾蔬菜，如白菜、黄瓜、冬瓜）。",
          "第三周：把部分精制主食换成全谷物（如糙米+白米混合煮）。",
          "持续：减少含糖饮料和油炸食品。",
          "不要一次改太多。小步快跑、能坚持的改变才是好改变。"
        ]
      }
    ],
    footer: "边界：本指南为健康教育提示，不替代心血管/肾病医生与营养师的个体化处方。若血压严重升高伴头痛/胸痛/视物模糊等，请立即就医。"
  },
  {
    id: "mediterranean",
    title: "地中海饮食",
    subtitle: "全球公认的心血管保护饮食模式 · 肾友好版本",
    sections: [
      {
        t: "什么是地中海饮食？",
        s: [
          "地中海饮食源自地中海沿岸国家的传统饮食模式（希腊、意大利南部等）。",
          "它是目前研究最充分、证据最强的心血管保护饮食之一，被多国指南推荐。",
          "核心特点：大量蔬菜水果、橄榄油为主要脂肪来源、鱼和海鲜为主要动物蛋白、全谷物、豆类、坚果、适量红酒（可选），极少红肉和加工食品。"
        ]
      },
      {
        t: "地中海饮食的 6 个核心要素",
        s: [
          "1. 橄榄油（特级初榨）：取代黄油/猪油/其他植物油作为日常烹饪油，富含单不饱和脂肪酸。",
          "2. 大量蔬果：每天至少 5 份蔬菜 + 3 份水果（注意：高钾患者需调整选择和份量）。",
          "3. 鱼和海鲜：每周至少 2 次，尤其是富含 omega-3 的深海鱼（三文鱼、鲭鱼、沙丁鱼等）。",
          "4. 全谷物、豆类、坚果：作为主食和零食的核心来源。",
          "5. 减少红肉和加工食品：红肉每月 2–3 次以内；加工肉（火腿、香肠等）尽量避免。",
          "6. 适量乳制品：以酸奶和奶酪为主（而非大量牛奶），低脂为佳。"
        ]
      },
      {
        t: "地中海饮食对哪些人有益？",
        s: [
          "心血管疾病高风险人群（高血压、糖尿病、高血脂）——大型研究（如 PREDIMED）显示可显著降低心血管事件。",
          "CKD 早期合并心血管风险者——有研究提示地中海饮食可能对肾功能保护有益。",
          "糖尿病患者——有助于改善血糖控制和胰岛素敏感性。",
          "肥胖/代谢综合征人群——地中海饮食在减重方面的长期依从性优于极端饮食。"
        ]
      },
      {
        t: "肾病患者的特别注意事项（非常重要）",
        s: [
          "高钾风险：地中海饮食富含蔬果、豆类、坚果——这些都是高钾食物。CKD 中晚期（eGFR < 30）或高血钾者，必须在营养师指导下筛选低钾蔬果、控制坚果和豆类份量。",
          "高磷风险：坚果、全谷物、豆类、奶酪含磷较高。透析或高血磷者需选择低磷替代品或控制份量。但植物性食物中的有机磷生物利用度较低（约 40–60%），比加工食品中的无机磷添加剂（>90%）好得多。",
          "蛋白质总量：地中海饮食蛋白质适中，但 CKD 3–5 期可能需要限制蛋白摄入（0.6–0.8g/kg/天），需与营养师个体化讨论。",
          "鱼类选择：深海鱼的 omega-3 有益心血管，但移植/免疫抑制患者需确保鱼类完全煮熟（避免生鱼片），以防食源性感染。",
          "红酒：肾病/移植/透析患者建议避免或严格限制酒精摄入，不建议为了'健康'而开始喝酒。"
        ]
      },
      {
        t: "实用替代建议（肾友好版）",
        s: [
          "用橄榄油替代其他烹饪油——这一步对所有人都安全且有益。",
          "选低钾蔬菜打底：白菜、黄瓜、生菜、卷心菜、冬瓜、洋葱、甜椒，再在允许范围内加番茄/菠菜。",
          "选低钾水果：苹果、梨、蓝莓、蔓越莓、葡萄，减少香蕉/橙子/猕猴桃的频次。",
          "坚果选小份量：每次一小把（15–20g），优先选核桃（omega-3 较高）。",
          "鱼每周 2 次：选择低汞品种，完全煮熟。",
          "不需要追求'完美的地中海饮食'——能做到 3–4 条就已经很好了。"
        ]
      },
      {
        t: "最省力的起步建议",
        s: [
          "第一步（本周）：把厨房的烹饪油换成特级初榨橄榄油。",
          "第二步：每周吃 2 次鱼（替代 1–2 次红肉）。",
          "第三步：每天加 1 份低钾蔬菜（清炒或凉拌均可）。",
          "第四步：用坚果（小份量）替代饼干/薯片作零食。",
          "慢慢来，不要一次颠覆所有饮食习惯。"
        ]
      }
    ],
    footer: "边界：本指南为健康教育提示，不替代心血管/肾病医生与营养师的个体化处方。肾功能不全者执行地中海饮食需在营养师指导下调整钾、磷、蛋白质摄入。"
  }
];

const KNOWLEDGE = [
  { id:"k_bp", tags:["kidney","htn"], title:"家庭血压：怎么测更准？", body:"固定时间、安静坐位、袖带合适、连续测两次取平均。把“周均值+波动”带去复诊，比单次数值更有用。", action:{label:"去记录血压", fn:"record_bp"} },
  { id:"htn_meds", tags:["htn"], title:"高血压用药：更重要的是‘坚持 + 记录’", body:"随访里最有价值的不是一次数字，而是：血压趋势 + 是否按医嘱服药 + 是否出现头晕/乏力等不适。App 内测版支持‘用药打卡’做复诊整理。", action:{label:"用药打卡", fn:"record_meds"} },
  { id:"k_protein", tags:["kidney","glomerular"], title:"尿蛋白/尿检怎么记录才对复诊有用？", body:"建议按日期记录：尿蛋白等级（或ACR/UPCR）、尿潜血、体重/水肿、血压。趋势比单次更重要。", action:{label:"去记录尿检", fn:"record_urine"} },
  { id:"k_tx_food", tags:["kidney","tx"], title:"移植期饮食：先守住“食品安全”", body:"免疫抑制期更怕食源性感染：避免生食/半生、注意分餐与冷藏、外卖选择更稳妥的熟食。具体以移植中心宣教为准。", action:{label:"查看饮食提醒", fn:"open_diet"} },
  { id:"k_electro", tags:["safety","electrolyte"], title:"电解质异常：先识别红旗，再谈饮食", body:"心悸、胸痛、抽搐、意识异常、呼吸困难等属于红旗。出现红旗应尽快就医/联系团队。饮食建议只能辅助，不能替代医疗处理。", action:{label:"打开红旗分诊", fn:"open_triage"} },
  { id:"s_water", tags:["stone"], title:"结石预防：把喝水拆成“分次策略”", body:"与其一次猛灌，不如把一天分成多个小目标（起床/上午/下午/晚间）。如果医生要求限水，请以医嘱为准。", action:{label:"去记录喝水", fn:"record_water"} },
  { id:"p_growth", tags:["peds"], title:"儿肾随访：把“生长”放到第一屏", body:"孩子的身高体重、生长速度与营养/肾功能密切相关。建议至少每月记录一次身高与体重（或按医生要求）。", action:{label:"去记录身高", fn:"record_height"} },
  { id:"p_bp", tags:["peds"], title:"儿童血压：不是固定阈值，而是“百分位”", body:"儿童血压解读常需要结合年龄/性别/身高百分位。App 内测版先做结构化记录与复诊整理，最终以儿肾医生判读为准。", action:{label:"去记录血压", fn:"record_bp"} },
  { id:"d_hd", tags:["dialysis"], title:"血透日：透前/透后记录能让复诊更高效", body:"建议记录：透前体重与血压、透后体重与血压、超滤量（如有）。长期看“间期体重增长趋势”比单次更有价值。", action:{label:"记录一次透析", fn:"record_dialysis"} },
  { id:"d_pd_redflag", tags:["dialysis"], title:"腹透红旗：透析液混浊/腹痛/发热要优先处理", body:"腹透出现透析液混浊、腹痛、发热等需要优先联系透析团队或就医。App 内测版先做“记录+分诊提示”。", action:{label:"打开红旗分诊", fn:"open_triage"} },
  { id:"d_fluid", tags:["dialysis"], title:"透析控水：先遵医嘱，再做记录", body:"透析患者常有控水/控盐要求。App 里会把“限水”作为高优先级提示，但具体目标以透析中心医嘱为准。", action:{label:"查看饮食提醒", fn:"open_diet"} },
  { id:"dm_glu", tags:["dm"], title:"血糖记录：给医生看的不是‘一个值’，是‘时间点+趋势’", body:"建议给每次血糖打标签（空腹/餐后/睡前/随机），并关注低血糖症状（出汗、心慌、手抖）。趋势与事件记录能显著提高复诊效率。", action:{label:"去记录血糖", fn:"record_glucose"} },
  { id:"dm_a1c", tags:["dm"], title:"HbA1c：更像‘过去2-3个月平均控糖的回放’", body:"HbA1c 常用于评估阶段性控糖水平。把每次结果按日期录入/上传报告，医生更容易判断是否需要调整方案。", action:{label:"去录入化验", fn:"record_labs"} },
];
// ====== Explainables ("为什么要做") ======
// Design goals:
// - Slightly detailed (6–10 lines) but not overwhelming
// - Same structure everywhere: 目的/看什么/怎么做/会用到哪里/红旗
// - Program-aware: tasks & record cards reference a stable explainer id
// NOTE: 文案是内测版占位，正式版建议由中心/医生端审核与配置下发。
const EXPLAINERS = {
  bp: {
    title: "家庭血压：为什么要测？",
    subtitle: "用于随访整理与复诊沟通（不替代医生）",
    why: "血压是肾脏与心血管风险的‘日常信号灯’，趋势比单次数字更重要。",
    focus: [
      "近7–14天平均值与波动幅度",
      "是否持续偏高/偏低，是否与头晕、胸闷、气促等症状相关",
      "是否与体重（体液变化）、尿蛋白/肾功能变化同步"
    ],
    howto: [
      "安静坐位休息3–5分钟后测量；袖带大小合适，手臂与心脏同水平",
      "尽量固定时间（晨起/晚间）记录，便于比较趋势",
      "若一次异常，建议间隔1–2分钟复测并备注当时情况"
    ],
    usedfor: [
      "进入趋势与一页摘要，帮助医生快速判断随访与管理重点",
      "触发安全提醒（如低血压症状/明显波动时的红旗提示）"
    ],
    redflags: ["胸痛、呼吸困难", "意识异常/抽搐/晕厥", "剧烈头痛伴肢体麻木或说话不清"],
    action: { label:"去记录血压", fn:"openQuickBP" }
  },
  weight: {
    title: "体重：为什么要记录？",
    subtitle: "短期体重变化常反映体液变化（水肿/脱水）",
    why: "肾病/透析/心血管人群中，体重是评估‘水分变化’最直观的家庭指标之一。",
    focus: [
      "几天内是否明显快速增加或下降",
      "是否伴浮肿、气促、尿量变化",
      "透析人群重点看‘间期体重增长’与干体重匹配"
    ],
    howto: [
      "建议每天同一时间（如晨起排空后）称重；同一秤/相近衣着",
      "透析日可分别记录透前/透后体重（如适用）",
      "备注可能影响体重的因素：外食很咸、腹泻/呕吐、发热、用药变化"
    ],
    usedfor: [
      "进入趋势与一页摘要，帮助团队评估控水/用药/随访频率",
      "与血压、尿量、症状合并解读更可靠"
    ],
    redflags: ["体重快速上升且气促/浮肿明显", "尿量明显减少/无尿", "明显头晕乏力或持续呕吐腹泻"],
    action: { label:"去记录体重", fn:"openQuickWeight" }
  },
  urine: {
    title: "尿检/尿蛋白：为什么要记录？",
    subtitle: "对肾小球病活动度与风险评估非常关键",
    why: "尿蛋白/血尿等信息能反映肾小球受损与疾病活动度，趋势比单次更有价值。",
    focus: [
      "尿蛋白（ACR/UPCR/24h尿蛋白）趋势",
      "潜血/红细胞变化与是否反复",
      "是否与血压、体重（水肿）同步变化"
    ],
    howto: [
      "按医院要求留取（常用中段尿）；尽量固定同一类指标以便趋势对比",
      "女性经期、剧烈运动、发热感染等请备注（可影响结果）",
      "若有报告原件/照片，建议同步上传到资料库，复诊更省时"
    ],
    usedfor: [
      "进入趋势与一页摘要，用于复诊沟通与随访计划调整",
      "可与专病指标（如MN的anti-PLA2R、LN的dsDNA/C3/C4）合并整理"
    ],
    redflags: ["肉眼血尿", "发热伴尿痛/腰痛", "血尿伴明显少尿/无尿"],
    action: { label:"去记录尿检", fn:"openAddUrine" }
  },
  labs: {
    title: "化验：为什么要录入？",
    subtitle: "肾功能、电解质、代谢与治疗安全的核心信息",
    why: "化验能帮助尽早发现肾功能波动、电解质紊乱与代谢异常，并为复诊决策提供依据。",
    focus: [
      "肌酐/eGFR：肾功能趋势",
      "K/Na/Ca/P/Mg：电解质与骨矿物相关线索",
      "血糖/HbA1c（如合并糖尿病）与相关风险"
    ],
    howto: [
      "尽量在同一实验室/同一单位随访；不同医院方法可能不同",
      "是否空腹按医院要求；近期感染、腹泻、用药变化请备注",
      "若上传化验单原件，后续更容易与医生核对"
    ],
    usedfor: [
      "触发安全提醒与饮食教育标签（如限钾/控磷/控糖等）",
      "进入趋势与一页摘要，并可被AI用于生成复诊问题清单（不诊断）"
    ],
    redflags: ["心悸/胸闷/抽搐/意识异常等症状时，优先就医或联系团队", "持续呕吐腹泻、明显乏力"],
    action: { label:"去录入化验", fn:"openAddLab" }
  },
  symptoms: {
    title: "症状自评：为什么要记录？",
    subtitle: "症状常早于化验变化，能帮助团队快速定位风险",
    why: "很多风险事件先表现为症状变化；结构化记录能减少漏诊并让复诊更高效。",
    focus: [
      "出现时间、严重程度、是否影响日常生活",
      "是否伴随发热、少尿/无尿、胸痛/气促等红旗",
      "与血压、体重、尿检、化验变化是否同向"
    ],
    howto: [
      "建议用‘时间+强度+伴随症状’三要素记录",
      "必要时可拍照（如水肿/透析液变化/皮疹等）并上传资料库",
      "出现红旗请不要只记录：优先联系随访团队或就医"
    ],
    usedfor: [
      "红旗分诊与安全提醒置顶",
      "进入一页摘要，并可由AI帮助整理成复诊沟通要点（不替代医生）"
    ],
    redflags: ["胸痛、呼吸困难", "意识异常/抽搐", "明显少尿/无尿", "发热寒战（尤其伴剧烈腰痛）"],
    action: { label:"去记录症状", fn:"quickSymptoms" }
  },
  tx_meds: {
    title: "移植：免疫抑制剂打卡为什么重要？",
    subtitle: "按时、按量、按流程，减少风险（以移植中心方案为准）",
    why: "免疫抑制剂需要稳定服用；漏服/延迟或时间点不清，会让风险评估与浓度解读更困难。",
    focus: [
      "是否漏服/延迟、是否自行增减",
      "抽血测谷浓度时的服药时间点与流程",
      "腹泻/呕吐等可能影响吸收的情况"
    ],
    howto: [
      "按医嘱固定时间服药；如要抽血测谷浓度，务必遵循中心流程",
      "出现严重腹泻/呕吐导致无法服药时，应尽快联系移植团队",
      "不要自行调整剂量，复诊时带上记录更有效"
    ],
    usedfor: [
      "进入一页摘要‘移植关键段’，减少复诊沟通成本",
      "与肌酐/eGFR、dd-cfDNA/DSA等信息合并整理"
    ],
    redflags: ["无法正常服药", "持续呕吐腹泻", "高热寒战/精神状态变差"],
    action: { label:"记录一次症状", fn:"quickSymptoms" }
  },
  tx_temp: {
    title: "移植：体温/感染自评为什么要做？",
    subtitle: "免疫抑制期感染风险更高，早发现更安全",
    why: "移植与免疫抑制期更容易出现感染；体温与症状记录有助于尽早识别并联系团队。",
    focus: [
      "是否持续发热、是否伴寒战",
      "伴随咳嗽、腹泻、尿痛等线索",
      "与近期用药、化验变化是否同向"
    ],
    howto: [
      "尽量固定同一种测温方式；记录发热开始时间与最高温",
      "若有外院化验/影像，请上传资料库便于团队快速查看",
      "出现明显不适请优先联系随访团队/就医"
    ],
    usedfor: [
      "触发安全提醒（红旗优先）",
      "进入一页摘要，帮助团队快速做下一步评估安排"
    ],
    redflags: ["高热寒战", "呼吸困难", "意识改变/嗜睡明显"],
    action: { label:"去红旗分诊", fn:"openTriageModal" }
  },
  glucose: {
    title: "血糖：为什么要记录？",
    subtitle: "合并糖尿病或用激素者：趋势与低血糖风险更重要",
    why: "血糖管理与心血管风险、感染风险及整体恢复相关；结构化记录能提高复诊效率。",
    focus: [
      "空腹/餐后（标注时间点）",
      "是否出现低血糖症状（出汗、心慌、手抖）",
      "HbA1c趋势（如有）"
    ],
    howto: [
      "记录时标注餐前/餐后/睡前等标签，便于医生判断",
      "出现低血糖按医嘱处理并记录事件",
      "不要仅凭单次值自行调整用药"
    ],
    usedfor: [
      "触发控糖饮食教育标签",
      "进入一页摘要并可生成复诊问题清单"
    ],
    redflags: ["意识模糊/晕厥疑似严重低血糖", "持续呕吐无法进食"],
    action: { label:"去记录血糖", fn:"openQuickGlucose" }
  },
  docs_vault: {
    title: "资料库：为什么要上传报告/图片？",
    subtitle: "把关键资料集中在一处，复诊沟通更高效",
    why: "活检、基因、影像、免疫学报告等‘原件’对医生判断非常关键。集中保存可减少遗漏与反复翻找。",
    focus: [
      "报告类型/日期/医院（越清晰越好）",
      "关键结论与图片清晰度",
      "同一检查多次随访时，按时间线归档"
    ],
    howto: [
      "优先上传PDF原件；如为照片，建议光线充足、对焦清晰",
      "上传时选择分类（活检/基因/影像/化验单等）便于复诊快速定位",
      "内测版为本地保存；正式版可接云端与医生端共享（需权限控制）"
    ],
    usedfor: [
      "资料汇总会进入一页摘要（数量+最近上传）",
      "未来可作为‘与医生共享的材料入口’（预留接口）"
    ],
    redflags: ["若报告提示紧急异常且伴明显不适，请优先联系医生/就医"],
    action: { label:"去上传资料", fn:"openDocUploadModal" }
  },
  markers_advanced: {
    title: "高级监测指标：为什么要记录？",
    subtitle: "用于随访整理与趋势（不做自我诊断）",
    review: "内测文案（待中心审核）",
    why: "dd-cfDNA、DSA、anti-PLA2R、dsDNA/C3/C4等指标常用于专病管理与复诊沟通。记录趋势能帮助团队更快抓重点。",
    focus: [
      "同一方法/单位下的趋势变化",
      "与肾功能、尿蛋白、症状是否同步",
      "尽量保留报告原件（不同医院差异很大）"
    ],
    howto: [
      "优先‘上传报告原件’，再补充结构化录入（日期/单位/结果）",
      "不要根据单项指标自行调整治疗方案",
      "出现红旗症状或肾功能快速变化时，优先联系团队"
    ],
    usedfor: [
      "进入一页摘要‘专病/移植关键段’，并支持AI生成复诊问题清单",
      "减少‘只记得阳性/阴性’导致的沟通信息损失"
    ],
    redflags: ["发热寒战、明显少尿/无尿、胸痛/气促、意识异常等红旗优先处理"],
    action: { label:"新增一次高级指标", fn:"openAddMarkerModal" }
  },
  mk_ddcfDNA: {
    title: "dd-cfDNA：为什么要记录？",
    subtitle: "移植随访常用辅助指标之一（不同平台差异大）",
    review: "内测文案（待中心审核）",
    why: "dd-cfDNA 常作为评估移植肾受损/免疫风险变化的辅助线索之一，通常需要结合肌酐/eGFR、尿蛋白、症状与其他免疫学信息一起看。我们记录它的目的，是让随访团队复诊时更快抓住趋势与变化点。",
    focus: [
      "更关注趋势变化（连续升高/降低）而非单次数值",
      "记录检测平台/单位/日期（不同平台参考范围可能不同）",
      "与肾功能、尿量变化、发热/腹泻等情况是否同步"
    ],
    howto: [
      "建议同步上传原始报告（PDF/图片），以保留平台信息与参考范围",
      "日期尽量填采样/抽血日期；不确定可填报告日期并在备注说明",
      "不要仅凭该指标自行判断或调整用药，出现不适请优先联系移植中心"
    ],
    usedfor: [
      "进入移植随访的一页摘要‘关键免疫/监测’段落",
      "支持趋势整理，AI 可辅助生成复诊问题清单（不诊断/不处方）"
    ],
    redflags: ["发热寒战/精神状态明显变差", "尿量明显减少/无尿", "持续呕吐腹泻导致无法服药"],
    action: { label:"去新增高级指标", fn:"openAddMarkerModal" }
  },
  mk_dsa: {
    title: "DSA：为什么要记录/上传？",
    subtitle: "供者特异性抗体报告常较复杂，原件更重要",
    review: "内测文案（待中心审核）",
    why: "DSA 报告通常包含分型与强度等信息（不同实验室展示方式不同）。记录/上传的意义在于：复诊时团队可以快速核对关键字段，并与肾功能、活检、dd-cfDNA 等信息综合判断。",
    focus: [
      "是否为新出现或明显变化（以医生解读为准）",
      "尽量保留完整报告原件（截图易漏关键字段）",
      "与肌酐/eGFR、蛋白尿、症状是否同时变化"
    ],
    howto: [
      "强烈建议上传完整报告（PDF/清晰照片），此处仅做摘要字段补充",
      "若报告有 MFI/分型等字段，可在备注中补充（可选）",
      "不要自行据此调整免疫抑制方案"
    ],
    usedfor: [
      "进入移植随访的一页摘要，减少复诊沟通成本",
      "支持时间线归档（便于团队对比前后变化）"
    ],
    redflags: ["合并肾功能快速变化", "发热寒战/明显不适", "明显少尿/无尿"],
    action: { label:"去上传报告", fn:"openDocUploadModal" }
  },
  mk_antiPLA2R: {
    title: "anti-PLA2R：为什么要记录？",
    subtitle: "膜性肾病随访常用免疫学指标（以医生解释为准）",
    review: "内测文案（待中心审核）",
    why: "在膜性肾病随访中，anti-PLA2R 常用于反映免疫活动的线索。把它与尿蛋白、肾功能、症状放在同一条时间线上，能让复诊沟通更高效。",
    focus: [
      "更关注趋势变化，而不是单次结果",
      "尽量同一实验室/同一方法随访（单位与参考范围可能不同）",
      "与尿蛋白/水肿、肌酐/eGFR 是否同步"
    ],
    howto: [
      "建议上传原始报告并填写采样/抽血日期（不确定可备注）",
      "如果报告写‘阴性/阳性’，也可以直接记录为结果",
      "不要仅凭该指标自行调整治疗，复诊时让医生综合判读"
    ],
    usedfor: [
      "进入MN（膜性肾病）工作区的趋势与一页摘要",
      "AI 可协助整理‘抗体-蛋白尿-肾功能’的变化点用于复诊提问"
    ],
    redflags: ["蛋白尿/水肿突然明显加重", "尿量明显减少/无尿", "出现胸痛、气促、意识异常等红旗"],
    action: { label:"去新增高级指标", fn:"openAddMarkerModal" }
  },
  mk_antiTHSD7A: {
    title: "anti-THSD7A：为什么要记录？",
    subtitle: "膜性肾病的可选补充指标（以中心检测为准）",
    review: "内测文案（待中心审核）",
    why: "部分膜性肾病患者可能会检测 anti-THSD7A 作为补充线索。记录/上传的意义主要在于复诊整理与时间线对比。",
    focus: ["是否做过该检测与结果（以报告为准）", "与尿蛋白与肾功能趋势是否同步"],
    howto: ["建议上传原始报告；如仅口头结论，建议备注检测机构/日期", "不要据此自行调整治疗"],
    usedfor: ["进入MN工作区资料汇总与一页摘要"],
    redflags: ["蛋白尿/水肿明显加重时尽快联系医生"],
    action: { label:"去上传报告", fn:"openDocUploadModal" }
  },
  mk_dsDNA: {
    title: "抗dsDNA：为什么要记录？",
    subtitle: "狼疮肾随访常用血清学线索之一（需综合解读）",
    review: "内测文案（待中心审核）",
    why: "在狼疮肾随访中，抗dsDNA 常与补体、尿蛋白/尿沉渣和肾功能一起用于评估免疫活动线索。记录的意义在于把变化放入时间线，方便复诊讨论。",
    focus: ["趋势变化（同一方法更可比）", "与补体C3/C4、蛋白尿、症状是否同向"],
    howto: ["建议上传报告原件并记录日期/单位（不同医院差异较大）", "不要用单项指标替代医生判断"],
    usedfor: ["进入LN工作区摘要与趋势整理", "AI 生成复诊问题清单（不诊断）"],
    redflags: ["发热寒战/明显不适", "尿量明显减少/无尿", "蛋白尿/水肿明显加重"],
    action: { label:"去新增高级指标", fn:"openAddMarkerModal" }
  },
  mk_c3: {
    title: "补体C3：为什么要记录？",
    subtitle: "狼疮肾/C3肾病等随访常用线索（参考范围因院而异）",
    review: "内测文案（待中心审核）",
    why: "C3 常用于反映免疫活动或补体消耗的线索之一，需要结合疾病类型、其他化验与临床表现综合解读。",
    focus: ["是否低于本院参考范围（以报告为准）", "与C4、dsDNA、尿蛋白/尿沉渣变化是否相关"],
    howto: ["建议同时上传原报告，保留参考范围与检测方法信息", "不同医院参考范围不同，尽量同院随访更可比"],
    usedfor: ["进入专病摘要与复诊整理"],
    redflags: ["出现明显不适或肾功能快速变化时优先联系医生"],
    action: { label:"去上传报告", fn:"openDocUploadModal" }
  },
  mk_c4: {
    title: "补体C4：为什么要记录？",
    subtitle: "狼疮肾随访常用线索（参考范围因院而异）",
    review: "内测文案（待中心审核）",
    why: "C4 常与C3、dsDNA等一起用于评估免疫活动线索。记录趋势能帮助复诊更快回顾变化。",
    focus: ["是否低于本院参考范围（以报告为准）", "与dsDNA、蛋白尿、症状是否同向"],
    howto: ["建议上传原报告并记录日期", "不同医院参考范围不同，趋势解读需由医生完成"],
    usedfor: ["进入LN工作区摘要与趋势整理"],
    redflags: ["发热寒战/精神差", "尿量明显减少/无尿"],
    action: { label:"去新增高级指标", fn:"openAddMarkerModal" }
  },
  mk_antiNephrin: {
    title: "anti-nephrin：为什么要记录？",
    subtitle: "MCD/FSGS 等人群的可选高级指标（以中心方案为准）",
    review: "内测文案（待中心审核）",
    why: "anti-nephrin 在部分中心用于肾病综合征/MCD 等人群的研究或辅助评估线索。对多数患者并非必查项，因此我们把它作为‘可选高级指标’：以归档与复诊整理为主。",
    focus: ["是否检测过与结果（阳性/阴性/滴度）", "与蛋白尿、水肿变化是否相关（由医生综合判断）"],
    howto: ["优先上传报告原件；此处可记录阳性/阴性或滴度/数值", "不要据此自行调整治疗"],
    usedfor: ["进入专病资料汇总与一页摘要（沟通用）"],
    redflags: ["蛋白尿/水肿突然明显加重", "明显少尿/无尿"],
    action: { label:"去上传报告", fn:"openDocUploadModal" }
  },
  hd_session: {
    title: "血透记录：为什么要记透前/透后？",
    subtitle: "水分管理与透析耐受的核心数据",
    why: "透前/透后体重血压与超滤量（UF）能反映控水策略与透析耐受，便于团队调整干体重与处方。",
    focus: [
      "间期体重增长趋势（比单次更重要）",
      "透析中/透后不适（头晕、抽筋、恶心等）",
      "超滤量与透后血压是否过低"
    ],
    howto: [
      "透析日尽量记录：透前体重/血压 → 透后体重/血压（可选UF）",
      "把当日特殊情况备注清楚（补液/抽筋/恶心/低血压处理等）",
      "若被要求限水/控盐，目标以透析中心医嘱为准"
    ],
    usedfor: [
      "生成‘最近3次透析摘要’，复诊讨论更高效",
      "与电解质（K/P等）趋势合并看更有意义"
    ],
    redflags: ["透后胸痛气促", "晕厥/意识异常", "持续明显低血压伴症状"],
    action: { label:"记录一次透析", fn:"openDialysisSessionModal" }
  },
  dialysis_access: {
    title: "通路/出口自检：为什么要做？",
    subtitle: "早发现功能异常或感染风险，避免严重并发症",
    why: "透析通路（内瘘/人工血管/导管/腹透出口）一旦感染或功能异常，风险高且处理紧迫。",
    focus: [
      "红肿热痛、渗液、出血",
      "内瘘震颤/杂音是否改变",
      "是否伴发热寒战"
    ],
    howto: [
      "建议每天简单自检；任何异常尽快联系透析中心",
      "不要自行处理渗液/化脓，按中心流程处理",
      "如果同时出现全身不适或发热，优先就医/联系团队"
    ],
    usedfor: [
      "触发安全提醒置顶",
      "帮助团队快速判断是否需要尽快就诊/处理"
    ],
    redflags: ["发热寒战", "通路剧痛/大量渗血", "意识异常"],
    action: { label:"打开红旗分诊", fn:"openTriageModal" }
  },
  pd_session: {
    title: "腹透记录：为什么要记UF/透析液外观？",
    subtitle: "腹膜炎等风险事件常先从‘浑浊/腹痛/发热’开始",
    why: "腹透相关风险（如腹膜炎）常先体现在透析液浑浊、腹痛、发热、UF变化。早记录早处理更安全。",
    focus: [
      "透析液是否清澈/浑浊（建议拍照）",
      "超滤量（UF）趋势是否明显变化",
      "是否伴腹痛、发热、恶心"
    ],
    howto: [
      "如出现浑浊，建议拍照并立即记录（不要等到复诊）",
      "按透析中心流程联系团队进行评估",
      "不要用App替代医疗处理：红旗优先"
    ],
    usedfor: [
      "红旗分诊与安全提醒（置顶）",
      "进入透析随访摘要，便于团队快速回顾事件时间线"
    ],
    redflags: ["透析液浑浊", "腹痛明显", "发热寒战"],
    action: { label:"记录一次腹透", fn:"openDialysisSessionModal" }
  },
  pd_exit: {
    title: "腹透出口护理：为什么要做？",
    subtitle: "出口护理是预防感染的关键",
    why: "出口感染往往先从局部红肿渗液开始；规范护理能降低感染风险。",
    focus: ["出口是否红肿、渗液、疼痛", "敷料是否潮湿/污染", "是否伴发热"],
    howto: ["按透析中心宣教流程护理与换药", "发现异常及时联系透析团队", "如有渗液/红肿可拍照上传资料库"],
    usedfor: ["护理提醒与事件记录", "帮助团队评估是否需要尽快处理"],
    redflags: ["渗液增多/脓性", "发热寒战", "局部剧痛"],
    action: { label:"打开红旗分诊", fn:"openTriageModal" }
  },
  water_stone: {
    title: "结石：饮水记录为什么重要？",
    subtitle: "提高尿量有助于降低复发风险；限水人群以医嘱优先",
    why: "结石管理中，足够尿量与分次饮水策略常是预防复发的基础。但若医生要求限水，必须以医嘱为准。",
    focus: ["是否做到分次饮水（比一次猛灌更可持续）", "哪些场景容易漏喝（外出/忙碌/夜间）", "尿色是否经常偏深"],
    howto: ["把一天拆成多个小目标（起床/上午/下午/晚间）", "睡前少量即可，避免夜间负担", "限水模式：只记录，不追‘喝够’目标"],
    usedfor: ["生成饮水达标周报与复诊摘要", "与发作事件时间线合并，帮助医生判断风险"],
    redflags: ["腰痛伴发热寒战", "无尿/少尿明显", "呕吐严重无法进食"],
    action: { label:"去记录饮水", fn:"openProgramMainModal" }
  },
  stone_event: {
    title: "结石发作事件：为什么要记录时间线？",
    subtitle: "时间线决定复诊效率，也能识别感染等急症风险",
    why: "结石发作的时间、症状与是否伴感染线索，会影响是否需要影像复查与处理路径。",
    focus: ["疼痛评分与持续时间", "血尿/尿量变化", "发热寒战（感染红旗）", "是否就医与影像结果"],
    howto: ["尽量记录开始时间与高峰时间", "如有影像/化验单请上传资料库", "发热+腰痛/寒战请优先就医"],
    usedfor: ["生成发作时间线摘要，复诊沟通更清晰", "减少‘说不清楚什么时候开始’造成的信息损失"],
    redflags: ["发热+腰痛/寒战", "无尿/少尿明显", "剧烈疼痛伴反复呕吐"],
    action: { label:"新增一次发作事件", fn:"openStoneEventModal" }
  },
  peds_growth: {
    title: "儿肾：为什么把生长放在第一屏？",
    subtitle: "身高/体重增长速度与营养、药物、肾功能密切相关",
    why: "儿肾随访不仅看化验，更要看生长趋势。持续监测可帮助团队更早发现营养或慢病影响。",
    focus: ["每月身高（建议）与体重趋势", "食欲/活动量变化", "与化验（肌酐/eGFR）同步情况"],
    howto: ["固定测量方式：同一尺、同一秤、同一时间段", "尽量每月记录一次身高（或按医嘱）", "监护人可协助记录与备注"],
    usedfor: ["生成生长趋势摘要，复诊时更容易讨论营养与治疗目标", "与儿科eGFR估算（需要身高）联动"],
    redflags: ["发热精神差", "持续呕吐腹泻", "尿量明显减少"],
    action: { label:"去记录身高", fn:"openQuickHeight" }
  },
  height_peds: {
    title: "儿肾：为什么要定期记录身高？",
    subtitle: "身高是生长速度的关键指标，也是部分评估的基础数据",
    why: "身高能反映生长速度；在儿肾随访中常用于综合评估营养与疾病影响，并可用于部分估算。",
    focus: ["是否有生长速度放缓", "与体重变化是否不匹配", "是否与近期疾病/用药变化相关"],
    howto: ["建议每月记录一次（或按医嘱），同一测量方式更可比", "记录日期与测量环境（晨/晚）", "如有明显变化可备注近期情况"],
    usedfor: ["进入生长趋势摘要，复诊讨论更具体", "用于儿科eGFR估算的必要字段之一"],
    redflags: ["明显消瘦或精神状态明显变差", "持续呕吐腹泻"],
    action: { label:"去记录身高", fn:"openQuickHeight" }
  },
  bp_peds: {
    title: "儿肾：儿童血压为什么要记录？",
    subtitle: "儿童血压解读常需结合年龄/性别/身高百分位",
    why: "儿童血压不像成人有固定阈值，通常需要结合年龄、性别、身高百分位综合判断；记录越规范越有价值。",
    focus: ["固定时间的趋势", "与头晕、乏力、肾功能/尿检变化的关联", "在复诊时提供‘家庭测量方案’依据"],
    howto: ["袖带大小要适合儿童；安静坐位后测量", "建议监护人协助固定时间记录", "App内测版用于整理，最终判读以儿肾医生为准"],
    usedfor: ["进入儿肾摘要与复诊问题清单", "帮助医生决定是否需要进一步检查（如ABPM等）"],
    redflags: ["胸痛/呼吸困难", "意识异常/抽搐", "持续严重头痛"],
    action: { label:"去记录血压", fn:"openQuickBP" }
  },
  labs_upload_peds: {
    title: "儿肾：上传/录入化验为什么重要？",
    subtitle: "儿科解读往往需要身高+肌酐单位+时间线",
    why: "儿科随访常需要把化验放在生长背景里解读；记录日期、单位与身高信息能显著提升复诊效率。",
    focus: ["肌酐单位与日期", "是否同时有身高记录（便于整理）", "尿检/蛋白尿与症状"],
    howto: ["建议同时记录身高与肌酐单位（医院间差异较大）", "有报告原件可上传资料库", "不要自行解读‘单次异常’决定用药"],
    usedfor: ["进入儿肾摘要与趋势整理", "帮助医生调整随访频率与评估计划"],
    redflags: ["明显少尿/无尿", "持续发热精神差"],
    action: { label:"去录入化验", fn:"openAddLab" }
  },
};
const FILE_DB_NAME = "kidneyCareFilesDB";
const FILE_DB_VERSION = 1;
const FILE_STORE = "files";
// ====== Advanced marker definitions (structured) ======
const MARKER_DEFS = {
  ddcfDNA: { key:"ddcfDNA", label:"dd-cfDNA（%）", unit:"%", scopes:["tx"], tip:"不同平台/单位可能不同；以移植中心解释为准。" },
  dsa: { key:"dsa", label:"DSA（供者特异性抗体）", unit:"", scopes:["tx"], tip:"建议上传完整报告；此处仅录入摘要字段。" },
  antiPLA2R: { key:"antiPLA2R", label:"anti-PLA2R（RU/mL）", unit:"RU/mL", scopes:["mn"], tip:"用于动态随访与复诊整理。" },
  antiTHSD7A: { key:"antiTHSD7A", label:"anti-THSD7A（可选）", unit:"", scopes:["mn"], tip:"如你有该检测，可作为补充录入/上传报告。" },
  antiNephrin: { key:"antiNephrin", label:"anti-nephrin（可选）", unit:"", scopes:["mcd","fsgs"], tip:"内测：建议优先上传报告原件；此处可录入阳性/阴性或滴度。" },
  dsDNA: { key:"dsDNA", label:"抗dsDNA", unit:"", scopes:["ln"], tip:"狼疮肾随访常用血清学指标之一。" },
  c3: { key:"c3", label:"补体C3", unit:"", scopes:["ln","c3g"], tip:"注意不同医院参考范围差异。" },
  c4: { key:"c4", label:"补体C4", unit:"", scopes:["ln"], tip:"注意不同医院参考范围差异。" },
};

// Map marker type -> dedicated explainer page (per-item explanation)
const MARKER_EXPLAINER_MAP = {
  ddcfDNA: 'mk_ddcfDNA',
  dsa: 'mk_dsa',
  antiPLA2R: 'mk_antiPLA2R',
  antiTHSD7A: 'mk_antiTHSD7A',
  antiNephrin: 'mk_antiNephrin',
  dsDNA: 'mk_dsDNA',
  c3: 'mk_c3',
  c4: 'mk_c4',
};
// ====== Doctor finder (placeholder + API interface reserved) ======
// NOTE: 内测版仅提供“UI + 接口占位 + 示例数据”。正式版需要：医生/机构库、地理编码、
// 合规与质量审核（避免误导/广告/灰产），并为患者提供透明的信息来源与更新时间。
const PROVIDER_MOCK = [
  { id:"p1", name:"示例：某三甲医院 肾内科门诊", specialties:["nephrology"], city:"北京", address:"东城区", lat:39.9042, lng:116.4074 },
  { id:"p2", name:"示例：某医院 透析中心", specialties:["dialysis"], city:"北京", address:"西城区", lat:39.9139, lng:116.3740 },
  { id:"p3", name:"示例：某医院 泌尿外科结石门诊", specialties:["urology"], city:"上海", address:"浦东", lat:31.2304, lng:121.4737 },
  { id:"p4", name:"示例：某儿童医院 儿肾专科", specialties:["peds_nephrology"], city:"广州", address:"越秀", lat:23.1291, lng:113.2644 },
  { id:"p5", name:"示例：某肾内科团队（社区/互联网）", specialties:["nephrology"], city:"线上", address:"可按医院/城市检索", lat:null, lng:null },
];
